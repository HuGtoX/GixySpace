name: æž„å»ºå’Œéƒ¨ç½² Tomato Tools

on:
    workflow_dispatch:

env:
    DOCKER_IMAGE_NAME: tomato-tools
    DOCKER_IMAGE_TAG: latest
    APP_DIR: /opt/tomato-tools

jobs:
    build-and-deploy:
        name: æž„å»ºå¹¶éƒ¨ç½²åˆ°è…¾è®¯äº‘
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm --filter @gixy/tomato-tools lint
              continue-on-error: true

            - name: è®¾ç½® Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: æž„å»º Docker é•œåƒ
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: false
                  load: true
                  tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
                  build-args: |
                      NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                      NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
                      NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: ä¿å­˜ Docker é•œåƒ
              run: docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} | gzip > tomato-tools-image.tar.gz

            - name: ä¸Šä¼ é•œåƒåˆ°æœåŠ¡å™¨
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  source: 'tomato-tools-image.tar.gz'
                  target: '/tmp/'
                  timeout: 10m

            - name: åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
              run: |
                  cat > .env.production << EOF
                  NODE_ENV=production
                  NEXT_TELEMETRY_DISABLED=1
                  PORT=3000
                  HOSTNAME=0.0.0.0
                  NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                  NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
                  NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
                  DATABASE_URL=${{ secrets.DATABASE_URL }}
                  SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
                  UPSTASH_REDIS_REST_URL=${{ secrets.UPSTASH_REDIS_REST_URL }}
                  UPSTASH_REDIS_REST_TOKEN=${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
                  AI_API_KEY=${{ secrets.AI_API_KEY }}
                  TD_AGENT_API_KEY=${{ secrets.TD_AGENT_API_KEY }}
                  HF_BASEURL=${{ secrets.HF_BASEURL }}
                  QWEATHER_KEY=${{ secrets.QWEATHER_KEY }}
                  COZE_API_KEY=${{ secrets.COZE_API_KEY }}
                  PINO_LOG_LEVEL=${{ secrets.PINO_LOG_LEVEL || 'info' }}
                  SMTP_HOST=${{ secrets.SMTP_HOST }}
                  SMTP_PORT=${{ secrets.SMTP_PORT }}
                  SMTP_USER=${{ secrets.SMTP_USER }}
                  SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
                  SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }}
                  SMTP_FROM_NAME=${{ secrets.SMTP_FROM_NAME }}
                  EOF

            - name: ä¸Šä¼ çŽ¯å¢ƒå˜é‡æ–‡ä»¶
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  source: '.env.production'
                  target: '/tmp/'

            - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  port: ${{ secrets.SERVER_PORT || 22 }}
                  timeout: 10m
                  script: |
                      set -e

                      echo "=========================================="
                      echo "å¼€å§‹éƒ¨ç½² Tomato Tools"
                      echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                      echo "=========================================="

                      # å®šä¹‰å˜é‡
                      APP_DIR="${{ env.APP_DIR }}"
                      IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
                      IMAGE_TAG="${{ env.DOCKER_IMAGE_TAG }}"
                      CONTAINER_NAME="tomato-tools"

                      # åˆ›å»ºåº”ç”¨ç›®å½•
                      echo "ðŸ“ åˆ›å»ºåº”ç”¨ç›®å½•..."
                      mkdir -p $APP_DIR
                      cd $APP_DIR

                      # å¤‡ä»½æ—§çš„çŽ¯å¢ƒæ–‡ä»¶
                      if [ -f ".env" ]; then
                          echo "ðŸ’¾ å¤‡ä»½æ—§çš„çŽ¯å¢ƒæ–‡ä»¶..."
                          cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
                      fi

                      # ç§»åŠ¨æ–°çš„çŽ¯å¢ƒæ–‡ä»¶
                      echo "ðŸ“ æ›´æ–°çŽ¯å¢ƒå˜é‡æ–‡ä»¶..."
                      mv /tmp/.env.production $APP_DIR/.env

                      # åŠ è½½ Docker é•œåƒ
                      echo "ðŸ“¦ åŠ è½½ Docker é•œåƒ..."
                      docker load < /tmp/tomato-tools-image.tar.gz

                      # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                      echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
                      rm -f /tmp/tomato-tools-image.tar.gz

                      # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                      if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                          echo "ðŸ’¾ å¤‡ä»½å½“å‰å®¹å™¨..."
                          BACKUP_IMAGE="${IMAGE_NAME}:backup-$(date +%Y%m%d_%H%M%S)"
                          docker commit $CONTAINER_NAME $BACKUP_IMAGE
                          echo "âœ… å¤‡ä»½é•œåƒ: $BACKUP_IMAGE"
                      fi

                      # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
                      echo "ðŸ›‘ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
                      if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
                          docker stop $CONTAINER_NAME || true
                          docker rm $CONTAINER_NAME || true
                      fi

                      # å¯åŠ¨æ–°å®¹å™¨
                      echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
                      docker run -d \
                        --name $CONTAINER_NAME \
                        --restart unless-stopped \
                        -p 3000:3000 \
                        --env-file $APP_DIR/.env \
                        $IMAGE_NAME:$IMAGE_TAG

                      # ç­‰å¾…å®¹å™¨å¯åŠ¨
                      echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
                      sleep 10

                      # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                      echo "ðŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
                      if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                          echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
                          echo ""
                          echo "å®¹å™¨ä¿¡æ¯:"
                          docker ps -f name=$CONTAINER_NAME --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                          echo ""
                          echo "æœ€è¿‘æ—¥å¿—:"
                          docker logs --tail 20 $CONTAINER_NAME
                      else
                          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
                          echo ""
                          echo "é”™è¯¯æ—¥å¿—:"
                          docker logs $CONTAINER_NAME
                          exit 1
                      fi

                      # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
                      echo "ðŸ§¹ æ¸…ç†æ—§é•œåƒ..."
                      docker images $IMAGE_NAME --format "{{.ID}} {{.CreatedAt}}" | \
                        tail -n +4 | \
                        awk '{print $1}' | \
                        xargs -r docker rmi -f || true

                      echo ""
                      echo "=========================================="
                      echo "âœ… éƒ¨ç½²å®Œæˆï¼"
                      echo "è®¿é—®åœ°å€: ${{ secrets.NEXT_PUBLIC_SITE_URL }}"
                      echo "=========================================="

            - name: å¥åº·æ£€æŸ¥
              run: |
                  echo "ðŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥..."
                  sleep 15

                  MAX_RETRIES=5
                  RETRY_COUNT=0

                  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                    if curl -f -s -o /dev/null "${{ secrets.NEXT_PUBLIC_SITE_URL }}/api/health"; then
                      echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                      echo "ðŸŽ‰ åº”ç”¨å·²æˆåŠŸéƒ¨ç½²å¹¶æ­£å¸¸è¿è¡Œ"
                      exit 0
                    fi
                    
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $RETRY_COUNT/$MAX_RETRIES..."
                    sleep 10
                  done

                  echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼è¯·æ£€æŸ¥åº”ç”¨æ—¥å¿—"
                  exit 1

            - name: éƒ¨ç½²ç»“æžœé€šçŸ¥
              if: always()
              run: |
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "ðŸŽ‰ =================================="
                    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
                    echo "ðŸŒ è®¿é—®åœ°å€: ${{ secrets.NEXT_PUBLIC_SITE_URL }}"
                    echo "â° éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                    echo "=================================="
                  else
                    echo "âŒ =================================="
                    echo "éƒ¨ç½²å¤±è´¥ï¼"
                    echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
                    echo "=================================="
                  fi
