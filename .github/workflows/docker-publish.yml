name: Test SSH Connection and File Transfer

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

jobs:
  test-ssh-transfer:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH key and known_hosts
      run: |
        # åˆ›å»º.sshç›®å½•
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # å°†SSHç§é’¥å†™å…¥æ–‡ä»¶
        echo "${{ secrets.SERVER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        
        # å°†æœåŠ¡å™¨å…¬é’¥æŒ‡çº¹æ·»åŠ åˆ°known_hostsï¼ˆé¿å…é¦–æ¬¡è¿æ¥æç¤ºï¼‰
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Create test file
      run: |
        # åˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„æµ‹è¯•æ–‡ä»¶
        echo "This is a test file from GitHub Actions" > test-transfer.txt
        echo "Generated at: $(date)" >> test-transfer.txt
        echo "Commit SHA: ${{ github.sha }}" >> test-transfer.txt
        echo "Repository: ${{ github.repository }}" >> test-transfer.txt
        
        # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ä»¥ä¾›éªŒè¯
        cat test-transfer.txt

    - name: Transfer file via SCP
      run: |
        # ä½¿ç”¨SCPä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨
        scp -i ~/.ssh/id_ed25519 \
            test-transfer.txt \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_UPLOAD_PATH || '/tmp/' }}
        
        echo "âœ… File transfer completed via SCP"

    - name: Verify file on server
      run: |
        # SSHè¿æ¥åˆ°æœåŠ¡å™¨éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        ssh -i ~/.ssh/id_ed25519 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "ls -la ${{ secrets.SERVER_UPLOAD_PATH || '/tmp/' }}test-transfer.txt && echo '--- File content ---' && cat ${{ secrets.SERVER_UPLOAD_PATH || '/tmp/' }}test-transfer.txt"
        
        echo "âœ… File verification successful"

    - name: Cleanup test file (optional)
      run: |
        # å¯é€‰ï¼šæ¸…ç†æœåŠ¡å™¨ä¸Šçš„æµ‹è¯•æ–‡ä»¶
        ssh -i ~/.ssh/id_ed25519 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "rm -f ${{ secrets.SERVER_UPLOAD_PATH || '/tmp/' }}test-transfer.txt"
        
        echo "ğŸ§¹ Test file cleaned up from server"
