name: Test SSH SCP Transfer

on:
  push:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘


env:
  # è®¾ç½®é»˜è®¤çŽ¯å¢ƒå˜é‡ï¼Œå¯åœ¨Secretsä¸­è¦†ç›–
  UPLOAD_PATH: "/tmp/github-actions-test/"

jobs:
  transfer-test:
    name: SCP File Transfer Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Create test artifacts
      run: |
        # åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æž„
        mkdir -p test-artifacts
        
        # åˆ›å»ºå¸¦è¯¦ç»†ä¿¡æ¯çš„æµ‹è¯•æ–‡ä»¶
        cat > test-artifacts/deployment-info.txt << EOF
        ===== GitHub Actions Deployment Test =====
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit SHA: ${{ github.sha }}
        Commit Message: ${{ github.event.head_commit.message }}
        Workflow: ${{ github.workflow }}
        Run ID: ${{ github.run_id }}
        Triggered by: ${{ github.actor }}
        Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        This file confirms successful SSH key configuration
        and SCP file transfer capabilities.
        EOF
        
        # åˆ›å»ºç¬¬äºŒä¸ªæµ‹è¯•æ–‡ä»¶
        echo "Simple test content for verification" > test-artifacts/simple-test.txt
        
        # åˆ›å»ºJSONæ ¼å¼çš„çŠ¶æ€æ–‡ä»¶
        cat > test-artifacts/deployment-status.json << EOF
        {
          "status": "test",
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "repository": "${{ github.repository }}",
          "commit": "${{ github.sha }}",
          "workflow": "${{ github.workflow }}"
        }
        EOF
        
        # æ˜¾ç¤ºåˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶
        echo "ðŸ“ Created test artifacts:"
        find test-artifacts -type f -exec echo "  {}" \;
        echo ""
        echo "ðŸ“„ Contents of deployment-info.txt:"
        cat test-artifacts/deployment-info.txt

    - name: SCP Transfer using appleboy/scp-action
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        source: "test-artifacts/*"
        target: ${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}
        strip_components: 0
        overwrite: true
        debug: true  # å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º

    - name: Verify transfer on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        script: |
          echo "ðŸ” Verifying transferred files on server..."
          echo "Target directory: ${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"
          echo ""
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}" ]; then
            echo "ðŸ“ Directory contents:"
            ls -la "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"
            echo ""
            
            # æ£€æŸ¥å…·ä½“æ–‡ä»¶
            echo "ðŸ“„ Checking test files:"
            for file in "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"deployment-info.txt \
                        "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"simple-test.txt \
                        "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"deployment-status.json; do
              if [ -f "$file" ]; then
                echo "âœ… $(basename "$file") exists"
                echo "   Size: $(wc -c < "$file") bytes"
                echo "   Permissions: $(stat -c "%A %U:%G" "$file")"
              else
                echo "âŒ $(basename "$file") not found"
              fi
            done
            
            echo ""
            echo "ðŸ“‹ Sample content from deployment-info.txt:"
            head -10 "${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"deployment-info.txt
            
            echo ""
            echo "ðŸŽ¯ SCP transfer verification completed successfully!"
          else
            echo "âŒ Target directory not found!"
            exit 1
          fi

    - name: Cleanup local test files
      if: always()  # å³ä½¿å¤±è´¥ä¹Ÿæ‰§è¡Œæ¸…ç†
      run: |
        echo "ðŸ§¹ Cleaning up local test artifacts..."
        rm -rf test-artifacts
        echo "Local cleanup completed"

    - name: Success notification
      if: success()
      run: |
        echo "ðŸŽ‰ SCP file transfer test completed successfully!"
        echo "All files were transferred and verified on the server."
        echo ""
        echo "Summary:"
        echo "  - Server: ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}"
        echo "  - Target: ${{ secrets.SERVER_UPLOAD_PATH || env.UPLOAD_PATH }}"
        echo "  - Files: deployment-info.txt, simple-test.txt, deployment-status.json"
