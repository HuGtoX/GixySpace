name: Test Daily Sentence Task # 测试每日一言定时任务

on:
    push:
        branches:
            - main
            - dev
        paths:
            - 'apps/frontend/tomato-tools/scripts/fetch-daily-sentence.ts'
            - '.github/workflows/test-scheduled-task.yml'
    workflow_dispatch: # 仅允许手动触发，用于测试
        inputs:
            test_mode:
                description: '测试模式'
                required: false
                default: 'dry-run'
                type: choice
                options:
                    - dry-run # 模拟运行，不实际写入数据库
                    - full # 完整运行，实际写入数据库

jobs:
    test-fetch-daily-sentence:
        runs-on: ubuntu-latest
        timeout-minutes: 10 # 设置超时时间为10分钟

        steps:
            # 步骤1：检出仓库代码
            - name: Checkout code
              uses: actions/checkout@v4

            # 步骤2：设置Node.js运行环境
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            # 步骤3：安装pnpm包管理器
            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 10.6.5

            # 步骤4：获取pnpm缓存目录
            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            # 步骤5：设置pnpm缓存
            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            # 步骤6：安装项目依赖
            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # 步骤7：验证脚本文件存在
            - name: Verify script file exists
              run: |
                  if [ ! -f "apps/frontend/tomato-tools/scripts/fetch-daily-sentence.ts" ]; then
                    echo "❌ 脚本文件不存在"
                    exit 1
                  fi
                  echo "✓ 脚本文件存在"

            # 步骤8：检查环境变量
            - name: Check environment variables
              run: |
                  if [ -z "${{ secrets.DATABASE_URL }}" ]; then
                    echo "⚠️  警告: DATABASE_URL 未设置"
                    echo "TEST_MODE=mock" >> $GITHUB_ENV
                  else
                    echo "✓ DATABASE_URL 已设置"
                    echo "TEST_MODE=real" >> $GITHUB_ENV
                  fi

            # 步骤9：测试API连接
            - name: Test Hitokoto API connection
              run: |
                  echo "测试每日一言API连接..."
                  response=$(curl -s -w "\n%{http_code}" "https://international.v1.hitokoto.cn?c=k")
                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | head -n-1)

                  if [ "$http_code" -eq 200 ]; then
                    echo "✓ API连接成功"
                    echo "响应示例: $(echo $body | jq -r '.hitokoto' | head -c 50)..."
                  else
                    echo "❌ API连接失败，HTTP状态码: $http_code"
                    exit 1
                  fi

            # 步骤10：运行定时任务（完整模式）
            - name: Run Daily Sentence Task (Full Mode)
              if: ${{ github.event.inputs.test_mode == 'full' && env.TEST_MODE == 'real' }}
              run: |
                  echo "=========================================="
                  echo "运行完整模式测试"
                  echo "=========================================="
                  pnpm run script:fetch-daily-sentence
              env:
                  NODE_ENV: production
                  DATABASE_URL: ${{ secrets.DATABASE_URL }}

            # 步骤11：运行定时任务（模拟模式）
            - name: Run Daily Sentence Task (Dry Run)
              if: ${{ github.event.inputs.test_mode == 'dry-run' || env.TEST_MODE == 'mock' }}
              run: |
                  echo "=========================================="
                  echo "运行模拟模式测试"
                  echo "=========================================="
                  echo "⚠️  模拟模式：不会实际写入数据库"
                  echo ""
                  echo "测试API调用..."
                  for i in {1..3}; do
                    echo "第 $i 次测试调用..."
                    response=$(curl -s "https://international.v1.hitokoto.cn?c=k")
                    hitokoto=$(echo $response | jq -r '.hitokoto')
                    from=$(echo $response | jq -r '.from')
                    echo "  内容: $hitokoto"
                    echo "  来源: $from"
                    echo ""
                    sleep 1
                  done
                  echo "✓ API调用测试完成"

            # 步骤12：验证执行结果
            - name: Verify execution result
              if: ${{ github.event.inputs.test_mode == 'full' && env.TEST_MODE == 'real' }}
              run: |
                  echo "=========================================="
                  echo "验证执行结果"
                  echo "=========================================="
                  echo "✓ 任务执行完成，请检查数据库确认数据是否正确写入"

            # 步骤13：生成测试报告
            - name: Generate test report
              if: always()
              run: |
                  echo "=========================================="
                  echo "测试报告"
                  echo "=========================================="
                  echo "测试时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                  echo "测试模式: ${{ github.event.inputs.test_mode || 'dry-run' }}"
                  echo "环境模式: ${{ env.TEST_MODE }}"
                  echo "Node版本: $(node --version)"
                  echo "pnpm版本: $(pnpm --version)"
                  echo "=========================================="

            # 步骤14：测试失败通知
            - name: Test failure notification
              if: failure()
              run: |
                  echo "❌ 测试失败！"
                  echo "请检查上述步骤的错误信息"
                  exit 1
