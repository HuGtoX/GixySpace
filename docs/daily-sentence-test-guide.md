# 每日一言定时任务测试指南

本文档介绍如何测试每日一言定时任务，确保其能够正常执行。

## 📋 目录

- [本地测试](#本地测试)
- [GitHub Actions测试](#github-actions测试)
- [测试检查项](#测试检查项)
- [常见问题](#常见问题)

## 🏠 本地测试

### 前置条件

1. 确保已安装依赖：

```bash
pnpm install
```

2. 配置环境变量：
   在项目根目录创建 `.env` 文件（如果还没有），添加以下内容：

```env
DATABASE_URL=your_database_connection_string
```

### 运行测试

#### 方式一：使用测试脚本（推荐）

```bash
# 在项目根目录运行
node apps/frontend/tomato-tools/scripts/test-fetch-daily-sentence.mjs
```

测试脚本会自动执行以下检查：

- ✅ 测试每日一言API连接
- ✅ 检查环境变量配置
- ✅ 验证脚本文件存在
- ✅ 运行定时任务
- ✅ 生成测试报告

#### 方式二：直接运行定时任务

```bash
# 在项目根目录运行
pnpm run script:fetch-daily-sentence
```

### 预期输出

成功执行时，你应该看到类似以下的输出：

```
========================================
开始执行每日一言定时任务
执行时间: 2025-11-19 10:00:00
========================================

检查今天是否已有数据...
今天还没有数据，开始获取...

第 1 次尝试获取每日一言...
✓ 成功获取到唯一内容: "人生如逆旅，我亦是行人..."

保存数据到数据库...
✓ 数据保存成功！

========================================
每日一言详情:
内容: 人生如逆旅，我亦是行人
来源: 临江仙·送钱穆父
作者: 苏轼
========================================

数据库连接已关闭

✓ 定时任务执行完成
```

## ☁️ GitHub Actions测试

### 测试工作流

我们提供了两个GitHub Actions工作流：

1. **测试工作流** (`test-scheduled-task.yml`) - 用于手动测试
2. **生产工作流** (`scheduled-tasks.yml`) - 每日自动执行

### 运行测试工作流

1. 访问你的GitHub仓库
2. 点击 `Actions` 标签
3. 在左侧选择 `Test Daily Sentence Task`
4. 点击右侧的 `Run workflow` 按钮
5. 选择测试模式：
    - **dry-run**（默认）：模拟运行，不写入数据库，仅测试API连接
    - **full**：完整运行，实际写入数据库

### 配置GitHub Secrets

在运行完整测试前，需要配置以下Secrets：

1. 访问仓库的 `Settings` → `Secrets and variables` → `Actions`
2. 点击 `New repository secret`
3. 添加以下Secret：
    - **Name**: `DATABASE_URL`
    - **Value**: 你的数据库连接字符串

### 测试步骤说明

测试工作流包含以下步骤：

1. ✅ 检出代码
2. ✅ 设置Node.js环境
3. ✅ 安装pnpm
4. ✅ 设置依赖缓存
5. ✅ 安装项目依赖
6. ✅ 验证脚本文件存在
7. ✅ 检查环境变量
8. ✅ 测试API连接
9. ✅ 运行定时任务
10. ✅ 验证执行结果
11. ✅ 生成测试报告

## 🔍 测试检查项

### 功能测试

- [ ] API连接正常
- [ ] 能够成功获取每日一言数据
- [ ] 内容去重功能正常（重复内容会重试）
- [ ] 数据能够正确保存到数据库
- [ ] 同一天不会重复获取数据

### 数据验证

执行任务后，检查数据库中的 `daily_sentences` 表：

```sql
-- 查看今天的数据
SELECT * FROM daily_sentences
WHERE fetch_date = CURRENT_DATE;

-- 检查是否有重复内容
SELECT content, COUNT(*) as count
FROM daily_sentences
GROUP BY content
HAVING COUNT(*) > 1;
```

### 错误处理测试

1. **数据库连接失败**：

    - 使用错误的 `DATABASE_URL`
    - 预期：任务失败并输出错误信息

2. **API连接失败**：

    - 断网或API不可用
    - 预期：重试后失败并输出错误信息

3. **重复数据处理**：
    - 多次运行任务
    - 预期：第二次运行时检测到今天已有数据，直接返回

## ❓ 常见问题

### Q1: 本地测试时提示 "DATABASE_URL 环境变量未设置"

**解决方案**：

1. 确保项目根目录有 `.env` 文件
2. 在 `.env` 文件中添加 `DATABASE_URL=your_connection_string`
3. 重新运行测试

### Q2: GitHub Actions测试失败，提示 "DATABASE_URL 未设置"

**解决方案**：

1. 检查GitHub仓库的Secrets配置
2. 确保添加了 `DATABASE_URL` Secret
3. 重新运行工作流

### Q3: 任务执行成功但数据库中没有数据

**可能原因**：

1. 数据库连接字符串错误
2. 数据库权限不足
3. 表结构不匹配

**解决方案**：

1. 验证数据库连接字符串
2. 检查数据库用户权限
3. 运行数据库迁移：`pnpm run db:migrate`

### Q4: API调用失败

**可能原因**：

1. 网络连接问题
2. API服务不可用
3. 请求频率过高

**解决方案**：

1. 检查网络连接
2. 稍后重试
3. 查看API文档确认限制

### Q5: 获取到重复内容，重试次数用尽

**说明**：
这是正常情况，说明数据库中已经有很多数据，随机获取到重复内容的概率增加。

**解决方案**：

1. 可以增加 `maxRetries` 参数（当前为10次）
2. 考虑清理旧数据
3. 这不影响正常使用，第二天会继续尝试

## 📊 监控建议

### 日志监控

在生产环境中，建议监控以下日志：

1. 任务执行成功/失败状态
2. API调用响应时间
3. 数据库写入耗时
4. 重试次数统计

### 告警设置

建议设置以下告警：

1. 连续3天任务执行失败
2. API响应时间超过5秒
3. 重试次数超过8次
4. 数据库连接失败

## 🔧 调试技巧

### 启用详细日志

在脚本中已经包含了详细的日志输出，如果需要更多调试信息，可以：

1. 在 `.env` 文件中添加：

```env
DEBUG=true
LOG_LEVEL=debug
```

2. 修改脚本中的日志级别

### 使用调试器

```bash
# 使用Node.js调试器
node --inspect apps/frontend/tomato-tools/scripts/fetch-daily-sentence.ts
```

## 📝 测试清单

在部署到生产环境前，请确保完成以下测试：

- [ ] 本地环境测试通过
- [ ] GitHub Actions dry-run模式测试通过
- [ ] GitHub Actions full模式测试通过
- [ ] 数据库数据验证正确
- [ ] 重复执行不会产生重复数据
- [ ] 错误处理机制正常工作
- [ ] 日志输出清晰完整
- [ ] 定时任务时间设置正确（北京时间凌晨0点）

## 🎯 下一步

测试通过后，定时任务会：

- 每天北京时间凌晨0点自动执行
- 获取一条唯一的每日一言
- 保存到数据库
- 前端页面自动展示最新内容

如有问题，请查看GitHub Actions的执行日志或联系开发团队。
