# AIä½¿ç”¨è®°å½•æ•°æ®åº“æ–¹æ¡ˆ - æ–‡æ¡£å¯¼èˆª

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬ç›®å½•åŒ…å«äº†ç•ªèŒ„å·¥å…·ç®±AIä½¿ç”¨è®°å½•æ•°æ®åº“æ–¹æ¡ˆçš„å®Œæ•´æ–‡æ¡£ã€‚

---

## ğŸ—‚ï¸ æ–‡æ¡£åˆ—è¡¨

### æ ¸å¿ƒæ–‡æ¡£

| æ–‡æ¡£                                                     | è¯´æ˜                   | é€‚åˆäººç¾¤             |
| -------------------------------------------------------- | ---------------------- | -------------------- |
| [ğŸ“– æ•°æ®åº“æ–¹æ¡ˆ](./ai-usage-database-schema.md)           | å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡ | æ‰€æœ‰å¼€å‘è€…           |
| [ğŸš€ å¿«é€Ÿå¼€å§‹](./ai-usage-quick-start.md)                 | 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹æŒ‡å—      | æ–°æ‰‹å¼€å‘è€…           |
| [ğŸ’¬ å¯¹è¯åˆ†ç±»è®¾è®¡](./ai-usage-conversation-categories.md) | å¯¹è¯åˆ†ç±»çš„è¯¦ç»†è¯´æ˜     | éœ€è¦ç»†åŒ–è¿½è¸ªçš„å¼€å‘è€… |
| [ğŸ“Š ERå›¾å’Œæµç¨‹å›¾](./ai-usage-database-diagram.md)        | å¯è§†åŒ–çš„æ•°æ®åº“è®¾è®¡     | æ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº   |

### æ›´æ–°æ–‡æ¡£

| æ–‡æ¡£                                                              | è¯´æ˜                     | é€‚åˆäººç¾¤               |
| ----------------------------------------------------------------- | ------------------------ | ---------------------- |
| [ğŸ†• å¯¹è¯åˆ†ç±»åŠŸèƒ½æ›´æ–°](./ai-usage-update-conversation-category.md) | å¯¹è¯åˆ†ç±»åŠŸèƒ½çš„æ›´æ–°è¯´æ˜   | å·²ä½¿ç”¨æ—§ç‰ˆæœ¬çš„å¼€å‘è€…   |
| [â­ AIè¯·æ±‚å‡½æ•°ä¼˜åŒ–](./ai-usage-optimization-summary.md)           | AIè¯·æ±‚å‡½æ•°ä¼˜åŒ–å®Œæˆæ€»ç»“   | æ‰€æœ‰å¼€å‘è€…             |
| [ğŸ“˜ é›†æˆæŒ‡å—](./ai-usage-integration-guide.md)                    | è¯¦ç»†çš„é›†æˆæ•™ç¨‹å’Œæœ€ä½³å®è·µ | éœ€è¦é›†æˆAIåŠŸèƒ½çš„å¼€å‘è€… |
| [ğŸ”§ æ•°æ®åº“è¿ç§»æŒ‡å—](./ai-usage-migration-guide.md)                | æ•°æ®åº“è¿ç§»å’Œæšä¸¾æ›´æ–°æŒ‡å— | é‡åˆ°æšä¸¾é”™è¯¯çš„å¼€å‘è€…   |

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æˆ‘æƒ³...

#### ğŸ“– äº†è§£æ•´ä½“æ–¹æ¡ˆ

â†’ é˜…è¯» [æ•°æ®åº“æ–¹æ¡ˆ](./ai-usage-database-schema.md)

#### ğŸš€ å¿«é€Ÿå¼€å§‹ä½¿ç”¨

â†’ é˜…è¯» [å¿«é€Ÿå¼€å§‹æŒ‡å—](./ai-usage-quick-start.md)

#### ğŸ’¬ äº†è§£å¯¹è¯åˆ†ç±»

â†’ é˜…è¯» [å¯¹è¯åˆ†ç±»è®¾è®¡æ–‡æ¡£](./ai-usage-conversation-categories.md)

#### ğŸ“Š æŸ¥çœ‹æ•°æ®åº“ç»“æ„å›¾

â†’ é˜…è¯» [ERå›¾å’Œæµç¨‹å›¾](./ai-usage-database-diagram.md)

#### ğŸ”„ ä»æ—§ç‰ˆæœ¬å‡çº§

â†’ é˜…è¯» [å¯¹è¯åˆ†ç±»åŠŸèƒ½æ›´æ–°](./ai-usage-update-conversation-category.md)

---

## ğŸ“‹ æ–¹æ¡ˆç‰¹ç‚¹

### âœ¨ æ ¸å¿ƒåŠŸèƒ½

- âœ… **å®Œæ•´è®°å½•** - è®°å½•æ¯æ¬¡AIè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
- âœ… **åŒå±‚åˆ†ç±»** - åœºæ™¯ + å¯¹è¯åˆ†ç±»çš„åŒå±‚ä½“ç³»
- âœ… **çµæ´»æ ‡ç­¾** - æ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾
- âœ… **æˆæœ¬è¿½è¸ª** - ç²¾ç¡®è®¡ç®—æ¯æ¬¡è°ƒç”¨çš„æˆæœ¬
- âœ… **æ€§èƒ½ä¼˜åŒ–** - åˆç†çš„ç´¢å¼•è®¾è®¡
- âœ… **ç»Ÿè®¡æ±‡æ€»** - æŒ‰æ—¥æœŸè‡ªåŠ¨æ±‡æ€»ç»Ÿè®¡æ•°æ®

### ğŸ¯ ä½¿ç”¨åœºæ™¯

1. **ç”¨æˆ·è¡Œä¸ºåˆ†æ** - äº†è§£ç”¨æˆ·å¦‚ä½•ä½¿ç”¨AIåŠŸèƒ½
2. **æˆæœ¬ç®¡ç†** - è¿½è¸ªå’Œæ§åˆ¶AIä½¿ç”¨æˆæœ¬
3. **æ€§èƒ½ç›‘æ§** - ç›‘æ§APIå“åº”æ—¶é—´å’ŒæˆåŠŸç‡
4. **é…é¢ç®¡ç†** - å®ç°ç”¨æˆ·ä½¿ç”¨é…é¢é™åˆ¶
5. **æ•°æ®æŠ¥å‘Š** - ç”Ÿæˆè¯¦ç»†çš„ä½¿ç”¨æŠ¥å‘Š

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### ä¸»è¦è¡¨

#### 1. ai_usage_logsï¼ˆAIä½¿ç”¨æ—¥å¿—è¡¨ï¼‰

è®°å½•æ¯æ¬¡AI APIè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯ã€‚

**å…³é”®å­—æ®µï¼š**

- ç”¨æˆ·ä¿¡æ¯ï¼ˆuser_idï¼‰
- ä½¿ç”¨åœºæ™¯ï¼ˆsceneï¼‰
- å¯¹è¯åˆ†ç±»ï¼ˆconversation_categoryï¼‰â­ æ–°å¢
- å¯¹è¯æ ‡ç­¾ï¼ˆconversation_tagsï¼‰â­ æ–°å¢
- Tokensä½¿ç”¨é‡ï¼ˆprompt_tokens, completion_tokens, total_tokensï¼‰
- é¢„ä¼°æˆæœ¬ï¼ˆestimated_costï¼‰
- è¯·æ±‚/å“åº”æ•°æ®ï¼ˆrequest_data, response_dataï¼‰
- è¯·æ±‚çŠ¶æ€ï¼ˆstatusï¼‰
- æ€§èƒ½æŒ‡æ ‡ï¼ˆdurationï¼‰

#### 2. ai_usage_statisticsï¼ˆAIä½¿ç”¨ç»Ÿè®¡è¡¨ï¼‰

æŒ‰æ—¥æœŸæ±‡æ€»ç”¨æˆ·çš„AIä½¿ç”¨æƒ…å†µã€‚

**å…³é”®å­—æ®µï¼š**

- è¯·æ±‚ç»Ÿè®¡ï¼ˆtotal_requests, success_requests, failed_requestsï¼‰
- Tokensç»Ÿè®¡ï¼ˆtotal_tokensï¼‰
- æˆæœ¬ç»Ÿè®¡ï¼ˆtotal_costï¼‰
- åœºæ™¯åˆ†å¸ƒï¼ˆscene_statsï¼‰
- åˆ†ç±»åˆ†å¸ƒï¼ˆcategory_statsï¼‰â­ æ–°å¢
- æ¨¡å‹åˆ†å¸ƒï¼ˆmodel_statsï¼‰

---

## ğŸ¨ åˆ†ç±»ä½“ç³»

### ä½¿ç”¨åœºæ™¯ï¼ˆSceneï¼‰- 7ç§

ç²—ç²’åº¦åˆ†ç±»ï¼Œæè¿°AIçš„ä¸»è¦ç”¨é€”ï¼š

- `chat` - èŠå¤©å¯¹è¯
- `summary` - å†…å®¹æ‘˜è¦
- `translation` - ç¿»è¯‘
- `code_generation` - ä»£ç ç”Ÿæˆ
- `text_optimization` - æ–‡æœ¬ä¼˜åŒ–
- `question_answer` - é—®ç­”
- `other` - å…¶ä»–

### å¯¹è¯åˆ†ç±»ï¼ˆConversation Categoryï¼‰- 21ç§ â­

ç»†ç²’åº¦åˆ†ç±»ï¼Œæè¿°å…·ä½“çš„å¯¹è¯ç±»å‹ï¼š

**é€šç”¨å¯¹è¯ç±»ï¼ˆ2ç§ï¼‰**

- general_chat, casual_conversation

**å·¥ä½œç›¸å…³ç±»ï¼ˆ5ç§ï¼‰**

- work_consultation, technical_support, code_review, debugging_help, architecture_design

**å­¦ä¹ æ•™è‚²ç±»ï¼ˆ3ç§ï¼‰**

- learning_tutorial, concept_explanation, homework_help

**åˆ›ä½œç±»ï¼ˆ3ç§ï¼‰**

- content_creation, writing_assistance, brainstorming

**æ•°æ®å¤„ç†ç±»ï¼ˆ3ç§ï¼‰**

- data_analysis, report_generation, document_summary

**è¯­è¨€å¤„ç†ç±»ï¼ˆ3ç§ï¼‰**

- translation_service, grammar_check, text_polishing

**å…¶ä»–ï¼ˆ1ç§ï¼‰**

- other

> ğŸ’¡ è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ [å¯¹è¯åˆ†ç±»è®¾è®¡æ–‡æ¡£](./ai-usage-conversation-categories.md)

---

## ğŸ’» ä»£ç ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```typescript
import { recordAiApiCall } from "@/lib/services/aiUsageService.example";

// è®°å½•AIè°ƒç”¨
await recordAiApiCall(
  userId,
  "chat", // åœºæ™¯
  requestData,
  responseData,
  {
    conversationCategory: "technical_support", // å¯¹è¯åˆ†ç±»
    conversationTags: ["react", "bug"], // æ ‡ç­¾
    ipAddress: "192.168.1.1",
    userAgent: "Mozilla/5.0...",
    duration: 2500,
  },
);
```

### æŸ¥è¯¢ç»Ÿè®¡

```typescript
import { getUserAiUsageStatistics } from "@/lib/services/aiUsageService.example";

// æŸ¥è¯¢æœ€è¿‘30å¤©çš„ç»Ÿè®¡
const stats = await getUserAiUsageStatistics(userId, {
  startDate: "2025-01-01",
  limit: 30,
});

// æŸ¥çœ‹åˆ†ç±»åˆ†å¸ƒ
stats.forEach((stat) => {
  console.log("å¯¹è¯åˆ†ç±»åˆ†å¸ƒ:", stat.categoryStats);
  // è¾“å‡ºï¼š{ "technical_support": 8, "code_review": 5, ... }
});
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
pnpm drizzle-kit generate
pnpm drizzle-kit push
```

### 2. åœ¨APIä¸­è®°å½•ä½¿ç”¨

```typescript
// app/api/chat/route.ts
export async function POST(request: Request) {
  const startTime = Date.now();

  // è°ƒç”¨AI API
  const response = await callAiApi(...);

  // è®°å½•ä½¿ç”¨æƒ…å†µ
  await recordAiApiCall(userId, "chat", requestData, response, {
    conversationCategory: "general_chat",
    duration: Date.now() - startTime,
  });

  return Response.json(response);
}
```

### 3. æŸ¥è¯¢å’Œå±•ç¤º

```typescript
// æŸ¥è¯¢ç”¨æˆ·ä½¿ç”¨æ—¥å¿—
const logs = await getUserAiUsageLogs(userId, {
  limit: 50,
});

// æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
const totalStats = await getUserTotalStatistics(userId);
console.log(`æ€»tokens: ${totalStats.totalTokens}`);
console.log(`æ€»æˆæœ¬: $${totalStats.totalCost}`);
```

---

## ğŸ“Š æ•°æ®åˆ†æç¤ºä¾‹

### æŒ‰åˆ†ç±»ç»Ÿè®¡ä½¿ç”¨é‡

```typescript
const categoryStats = await db
  .select({
    category: aiUsageLogs.conversationCategory,
    count: sql<number>`COUNT(*)`,
    totalTokens: sql<number>`SUM(${aiUsageLogs.totalTokens})`,
  })
  .from(aiUsageLogs)
  .where(eq(aiUsageLogs.userId, userId))
  .groupBy(aiUsageLogs.conversationCategory);
```

### è¯†åˆ«é«˜æˆæœ¬å¯¹è¯ç±»å‹

```typescript
const costByCategory = await db
  .select({
    category: aiUsageLogs.conversationCategory,
    totalCost: sql<number>`SUM(${aiUsageLogs.estimatedCost})`,
  })
  .from(aiUsageLogs)
  .groupBy(aiUsageLogs.conversationCategory)
  .orderBy(desc(sql`SUM(${aiUsageLogs.estimatedCost})`));
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“Schema

- [aiUsage.ts](../src/lib/drizzle/schema/aiUsage.ts) - AIä½¿ç”¨è®°å½•è¡¨å®šä¹‰
- [schema.ts](../src/lib/drizzle/schema/schema.ts) - ä¸»Schemaæ–‡ä»¶

### æœåŠ¡å±‚

- [aiUsageService.example.ts](../src/lib/services/aiUsageService.example.ts) - æœåŠ¡å±‚ç¤ºä¾‹ä»£ç 

### æ–‡æ¡£

- [ai-usage-database-schema.md](./ai-usage-database-schema.md) - å®Œæ•´æ•°æ®åº“æ–¹æ¡ˆ
- [ai-usage-conversation-categories.md](./ai-usage-conversation-categories.md) - å¯¹è¯åˆ†ç±»è¯¦ç»†è¯´æ˜
- [ai-usage-database-diagram.md](./ai-usage-database-diagram.md) - ERå›¾å’Œæµç¨‹å›¾
- [ai-usage-quick-start.md](./ai-usage-quick-start.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [ai-usage-update-conversation-category.md](./ai-usage-update-conversation-category.md) - å¯¹è¯åˆ†ç±»åŠŸèƒ½æ›´æ–°è¯´æ˜

---

## ğŸ”§ æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: PostgreSQL
- **ORM**: Drizzle ORM
- **è¯­è¨€**: TypeScript
- **æ¡†æ¶**: Next.js 15

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¼‚æ­¥è®°å½•æ—¥å¿—

```typescript
// ä¸è¦ç­‰å¾…æ—¥å¿—è®°å½•å®Œæˆï¼Œé¿å…å½±å“APIå“åº”é€Ÿåº¦
recordAiApiCall(...).catch(err => console.error(err));
```

### 2. å®šæœŸæ¸…ç†æ—§æ•°æ®

```typescript
// æ¸…ç†90å¤©å‰çš„è¯¦ç»†æ—¥å¿—ï¼Œä¿ç•™ç»Ÿè®¡æ•°æ®
await db
  .delete(aiUsageLogs)
  .where(
    lte(aiUsageLogs.createdAt, new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)),
  );
```

### 3. å®ç°é…é¢ç®¡ç†

```typescript
// æ£€æŸ¥ç”¨æˆ·ä»Šæ—¥ä½¿ç”¨é‡
const todayStats = await getUserAiUsageStatistics(userId, {
  startDate: new Date().toISOString().split("T")[0],
});

if (todayStats[0]?.totalTokens > USER_DAILY_QUOTA) {
  throw new Error("Daily quota exceeded");
}
```

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### 1. ç”¨æˆ·ä»ªè¡¨æ¿

å±•ç¤ºç”¨æˆ·çš„AIä½¿ç”¨æƒ…å†µï¼š

- ä»Šæ—¥/æœ¬æœˆä½¿ç”¨é‡
- Tokensæ¶ˆè€—è¶‹åŠ¿
- æˆæœ¬ç»Ÿè®¡
- å¯¹è¯åˆ†ç±»åˆ†å¸ƒ

### 2. ç®¡ç†åå°

ç®¡ç†å‘˜æŸ¥çœ‹å…¨å±€ç»Ÿè®¡ï¼š

- æ€»ä½“ä½¿ç”¨è¶‹åŠ¿
- çƒ­é—¨å¯¹è¯ç±»å‹
- æˆæœ¬åˆ†æ
- å¼‚å¸¸ä½¿ç”¨æ£€æµ‹

### 3. æˆæœ¬ä¼˜åŒ–

åŸºäºæ•°æ®ä¼˜åŒ–æˆæœ¬ï¼š

- è¯†åˆ«é«˜æˆæœ¬åœºæ™¯
- ä¼˜åŒ–æ¨¡å‹é€‰æ‹©
- å®æ–½é…é¢é™åˆ¶
- æˆæœ¬é¢„è­¦

### 4. äº§å“ä¼˜åŒ–

åŸºäºä½¿ç”¨æ•°æ®æ”¹è¿›äº§å“ï¼š

- äº†è§£ç”¨æˆ·éœ€æ±‚
- ä¼˜åŒ–åŠŸèƒ½è®¾è®¡
- æå‡ç”¨æˆ·ä½“éªŒ
- å‘ç°æ–°æœºä¼š

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•é€‰æ‹©åˆé€‚çš„å¯¹è¯åˆ†ç±»ï¼Ÿ**  
A: æŸ¥çœ‹ [å¯¹è¯åˆ†ç±»è®¾è®¡æ–‡æ¡£](./ai-usage-conversation-categories.md) ä¸­çš„è¯¦ç»†è¯´æ˜å’Œç¤ºä¾‹ã€‚

**Q: å¦‚ä½•è®¡ç®—AIè°ƒç”¨æˆæœ¬ï¼Ÿ**  
A: å‚è€ƒ [æ•°æ®åº“æ–¹æ¡ˆ](./ai-usage-database-schema.md) ä¸­çš„æˆæœ¬è®¡ç®—éƒ¨åˆ†ã€‚

**Q: å¦‚ä½•å®ç°é…é¢é™åˆ¶ï¼Ÿ**  
A: å‚è€ƒ [å¿«é€Ÿå¼€å§‹æŒ‡å—](./ai-usage-quick-start.md) ä¸­çš„é…é¢ç®¡ç†ç¤ºä¾‹ã€‚

### è·å–æ”¯æŒ

1. æŸ¥çœ‹ç›¸å…³æ–‡æ¡£
2. æŸ¥çœ‹ä»£ç ç¤ºä¾‹
3. æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹

---

## ğŸ‰ å¼€å§‹ä½¿ç”¨

é€‰æ‹©é€‚åˆä½ çš„æ–‡æ¡£å¼€å§‹ï¼š

- ğŸ†• **æ–°ç”¨æˆ·** â†’ [å¿«é€Ÿå¼€å§‹æŒ‡å—](./ai-usage-quick-start.md)
- ğŸ“– **è¯¦ç»†äº†è§£** â†’ [æ•°æ®åº“æ–¹æ¡ˆ](./ai-usage-database-schema.md)
- ğŸ’¬ **ä½¿ç”¨åˆ†ç±»** â†’ [å¯¹è¯åˆ†ç±»è®¾è®¡](./ai-usage-conversation-categories.md)
- ğŸ”„ **ç‰ˆæœ¬å‡çº§** â†’ [å¯¹è¯åˆ†ç±»åŠŸèƒ½æ›´æ–°](./ai-usage-update-conversation-category.md)

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸš€
