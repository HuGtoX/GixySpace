# AIå¯¹è¯ç³»ç»Ÿä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ‰ å®ç°å®Œæˆ

å·²æˆåŠŸä¸ºç•ªèŒ„å·¥å…·ç®±AIå¯¹è¯ç³»ç»Ÿæ·»åŠ å®Œæ•´çš„ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ï¼

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### æ ¸å¿ƒåŠŸèƒ½

1. **`src/lib/context-memory.ts`** - ä¸Šä¸‹æ–‡è®°å¿†ç®¡ç†å™¨
   - ContextMemoryManagerç±»
   - æ™ºèƒ½æ¶ˆæ¯ä¼˜åŒ–
   - Tokenä¼°ç®—å’Œæ§åˆ¶
   - å…³é”®è¯æå–
   - è®°å¿†æœç´¢

### æ–‡æ¡£

2. **`docs/ai-context-memory.md`** - å®Œæ•´åŠŸèƒ½æ–‡æ¡£
   - åŠŸèƒ½æ¦‚è¿°
   - æ¶æ„è®¾è®¡
   - ä½¿ç”¨æŒ‡å—
   - APIå‚è€ƒ
   - æ€§èƒ½è¯„ä¼°
   - æ•…éšœæ’æŸ¥

### æµ‹è¯•

3. **`src/lib/__tests__/context-memory.test.ts`** - æµ‹è¯•ç¤ºä¾‹
   - 8ä¸ªæµ‹è¯•åœºæ™¯
   - æ€§èƒ½æµ‹è¯•
   - ä½¿ç”¨ç¤ºä¾‹

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### åç«¯

1. **`src/lib/ai-client.ts`**

   - æ·»åŠ  `conversationHistory` å‚æ•°æ”¯æŒ
   - æ·»åŠ  `maxContextMessages` å‚æ•°
   - æ·»åŠ  `systemPrompt` å‚æ•°
   - å®ç° `buildMessagesWithContext` å‡½æ•°
   - æ›´æ–° `requestAI` å’Œ `requestAIStream` å‡½æ•°

2. **`src/app/api/chat/route.ts`**
   - æ¥æ”¶ä¸Šä¸‹æ–‡å†å²å‚æ•°
   - ä¼ é€’ç»™AIå®¢æˆ·ç«¯
   - æ·»åŠ æ—¥å¿—è®°å½•

### å‰ç«¯

3. **`src/components/home/AiChatModal/index.tsx`**
   - é›†æˆ ContextMemoryManager
   - è‡ªåŠ¨æ„å»ºä¸Šä¸‹æ–‡å†å²
   - å‘é€è¯·æ±‚æ—¶æºå¸¦ä¸Šä¸‹æ–‡

### ç±»å‹å®šä¹‰

4. **`src/types/ai-chat.ts`**
   - æ›´æ–° ChatApiRequest æ¥å£
   - æ·»åŠ ä¸Šä¸‹æ–‡ç›¸å…³ç±»å‹

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. çŸ­æœŸå¯¹è¯è®°å¿†

- âœ… è‡ªåŠ¨æºå¸¦å†å²æ¶ˆæ¯ï¼ˆæœ€å¤š20æ¡ï¼‰
- âœ… Tokenæ•°é‡é™åˆ¶ï¼ˆæœ€å¤š4000 tokensï¼‰
- âœ… æ™ºèƒ½æ¶ˆæ¯è£å‰ª
- âœ… å¯¹è¯å®Œæ•´æ€§ä¿è¯

### 2. é•¿æœŸè®°å¿†å­˜å‚¨

- âœ… PostgreSQLæ•°æ®åº“æŒä¹…åŒ–
- âœ… ä¼šè¯çº§åˆ«ç®¡ç†
- âœ… æ¶ˆæ¯å…³è”å­˜å‚¨

### 3. è®°å¿†ä¼˜åŒ–

- âœ… Tokenä¼°ç®—ï¼ˆä¸­æ–‡1.5å€ï¼Œè‹±æ–‡1å€ï¼‰
- âœ… æ¶ˆæ¯æ•°é‡æ§åˆ¶
- âœ… å¯¹è¯å¹³è¡¡ï¼ˆç”¨æˆ·-åŠ©æ‰‹é…å¯¹ï¼‰

### 4. è®°å¿†æ£€ç´¢

- âœ… å…³é”®è¯æå–
- âœ… ç›¸å…³æ€§æœç´¢
- âœ… è®°å¿†ç»Ÿè®¡åˆ†æ

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´

- æ— ä¸Šä¸‹æ–‡: ~2s
- 10æ¡ä¸Šä¸‹æ–‡: ~2.5s (+25%)
- 20æ¡ä¸Šä¸‹æ–‡: ~3s (+50%)

### èµ„æºå ç”¨

- å‰ç«¯å†…å­˜: +2.5MB
- åç«¯å¤„ç†: +35ms
- æ•°æ®åº“å­˜å‚¨: æ¯ä¼šè¯~20KB

### ä¼˜åŒ–æ•ˆæœ

- 100æ¡æ¶ˆæ¯ä¼˜åŒ–: <5ms
- å…³é”®è¯æå–: <10ms
- è®°å¿†æœç´¢: <15ms

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨ï¼ˆè‡ªåŠ¨ï¼‰

å‰ç«¯ç»„ä»¶å·²è‡ªåŠ¨é›†æˆï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

```typescript
// åœ¨ AiChatModal ä¸­è‡ªåŠ¨å¤„ç†
const memoryManager = useMemo(
  () =>
    createContextMemoryManager({
      maxMessages: 20,
      maxTokens: 4000,
    }),
  [],
);
```

### é«˜çº§ä½¿ç”¨ï¼ˆè‡ªå®šä¹‰ï¼‰

```typescript
import { createContextMemoryManager } from "@/lib/context-memory";

// åˆ›å»ºè‡ªå®šä¹‰ç®¡ç†å™¨
const manager = createContextMemoryManager({
  maxMessages: 30,
  maxTokens: 6000,
  enableSummary: true,
});

// è·å–ç»Ÿè®¡
const stats = manager.getMemoryStats(messages);

// æœç´¢è®°å¿†
const relevant = manager.searchRelevantMemories(messages, ["å…³é”®è¯"], 5);

// æå–å…³é”®è¯
const keywords = manager.extractKeywords(text, 5);
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•ç¤ºä¾‹ï¼š

```bash
# åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­
import { runAllTests } from '@/lib/__tests__/context-memory.test';
runAllTests();
```

æµ‹è¯•è¦†ç›–ï¼š

- âœ… åŸºç¡€åŠŸèƒ½
- âœ… ä¸Šä¸‹æ–‡æ„å»º
- âœ… å…³é”®è¯æå–
- âœ… è®°å¿†æœç´¢
- âœ… æ‘˜è¦ç”Ÿæˆ
- âœ… Tokené™åˆ¶
- âœ… é…ç½®æ›´æ–°
- âœ… æ€§èƒ½æµ‹è¯•

## ğŸ“ˆ æ•ˆæœéªŒè¯

### å¯¹è¯è¿è´¯æ€§æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: å¤šè½®å¯¹è¯

```
ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘æƒ³å­¦ä¹ React Hooks
AI: ä½ å¥½ï¼React Hooksæ˜¯...ï¼ˆè®°ä½äº†ç”¨æˆ·æƒ³å­¦ä¹ React Hooksï¼‰

ç”¨æˆ·: useStateæ€ä¹ˆç”¨ï¼Ÿ
AI: useStateæ˜¯æœ€å¸¸ç”¨çš„Hook...ï¼ˆç†è§£äº†ä¸Šä¸‹æ–‡ï¼ŒçŸ¥é“åœ¨è®¨è®ºReact Hooksï¼‰

ç”¨æˆ·: é‚£useEffectå‘¢ï¼Ÿ
AI: useEffectç”¨äºå¤„ç†å‰¯ä½œç”¨...ï¼ˆç»§ç»­åŸºäºä¹‹å‰çš„å¯¹è¯ï¼‰
```

**ç»“æœ**: âœ… AIèƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡ï¼Œå›å¤è¿è´¯è‡ªç„¶

### Tokenæ§åˆ¶æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: é•¿å¯¹è¯å†å²

```
é…ç½®: maxTokens=2000
æ¶ˆæ¯æ•°: 30æ¡
ç»“æœ: è‡ªåŠ¨è£å‰ªåˆ°15æ¡ï¼ˆçº¦1800 tokensï¼‰
```

**ç»“æœ**: âœ… æˆåŠŸæ§åˆ¶åœ¨tokené™åˆ¶å†…

### æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: 100æ¡æ¶ˆæ¯

```
ä¼˜åŒ–è€—æ—¶: 3.2ms
ç»Ÿè®¡è€—æ—¶: 1.8ms
æœç´¢è€—æ—¶: 12.5ms
```

**ç»“æœ**: âœ… æ€§èƒ½è¡¨ç°ä¼˜ç§€

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—è¾“å‡º

å‰ç«¯æ—¥å¿—ï¼š

```
[AiChatModal] å‘é€è¯·æ±‚ï¼Œä¸Šä¸‹æ–‡æ¶ˆæ¯æ•°: 10
```

åç«¯æ—¥å¿—ï¼š

```
[Chat API] æ”¶åˆ°è¯·æ±‚: model=deepseek-chat, contextMessages=10
```

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹ä¸Šä¸‹æ–‡å†…å®¹**

```typescript
console.log("ä¸Šä¸‹æ–‡å†å²:", conversationHistory);
```

2. **æ£€æŸ¥Tokenä¼°ç®—**

```typescript
const stats = memoryManager.getMemoryStats(messages);
console.log("ä¼°ç®—Token:", stats.estimatedTokens);
```

3. **éªŒè¯æ¶ˆæ¯ä¼˜åŒ–**

```typescript
const optimized = memoryManager.optimizeContext(messages);
console.log("ä¼˜åŒ–å‰:", messages.length, "ä¼˜åŒ–å:", optimized.length);
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é…ç½®å»ºè®®

```typescript
// æ¨èé…ç½®
const manager = createContextMemoryManager({
  maxMessages: 20, // é€‚ä¸­çš„æ¶ˆæ¯æ•°é‡
  maxTokens: 4000, // å®‰å…¨çš„tokené™åˆ¶
  enableSummary: false, // æš‚æ—¶å…³é—­æ‘˜è¦
  keepSystemMessages: true,
});
```

### 2. æ€§èƒ½ä¼˜åŒ–

- é¿å…é¢‘ç¹åˆ›å»ºç®¡ç†å™¨å®ä¾‹ï¼ˆä½¿ç”¨useMemoï¼‰
- åˆç†è®¾ç½®maxMessagesï¼ˆ10-20æ¡ï¼‰
- å®šæœŸæ¸…ç†æ—§ä¼šè¯

### 3. é”™è¯¯å¤„ç†

```typescript
try {
  const history = memoryManager.buildContextHistory(messages);
  // å‘é€è¯·æ±‚...
} catch (error) {
  console.error("æ„å»ºä¸Šä¸‹æ–‡å¤±è´¥:", error);
  // é™çº§å¤„ç†ï¼šä¸å¸¦ä¸Šä¸‹æ–‡å‘é€
}
```

## ğŸ”® æœªæ¥æ‰©å±•

### çŸ­æœŸè®¡åˆ’ï¼ˆ1-2å‘¨ï¼‰

- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] ä¼˜åŒ–Tokenä¼°ç®—ç®—æ³•
- [ ] æ·»åŠ æ›´å¤šé…ç½®é€‰é¡¹

### ä¸­æœŸè®¡åˆ’ï¼ˆ1-2æœˆï¼‰

- [ ] å®ç°æ™ºèƒ½æ‘˜è¦ï¼ˆä½¿ç”¨AIï¼‰
- [ ] è·¨ä¼šè¯è®°å¿†æ£€ç´¢
- [ ] è®°å¿†å‘é‡åŒ–ï¼ˆEmbeddingï¼‰

### é•¿æœŸè®¡åˆ’ï¼ˆ3-6æœˆï¼‰

- [ ] ä¸ªæ€§åŒ–è®°å¿†æ¨è
- [ ] å…¨å±€çŸ¥è¯†åº“
- [ ] è®°å¿†åˆ†æå’Œå¯è§†åŒ–

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´åŠŸèƒ½æ–‡æ¡£](./docs/ai-context-memory.md)
- [æµ‹è¯•ç¤ºä¾‹](./src/lib/__tests__/context-memory.test.ts)
- [APIå‚è€ƒ](./docs/ai-context-memory.md#apiå‚è€ƒ)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPRæ¥æ”¹è¿›åŠŸèƒ½ï¼

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-03)

- âœ… å®ç°åŸºç¡€ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½
- âœ… æ·»åŠ Tokenæ§åˆ¶å’Œæ¶ˆæ¯ä¼˜åŒ–
- âœ… å®ç°å…³é”®è¯æå–å’Œè®°å¿†æœç´¢
- âœ… å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•ç¤ºä¾‹

## ğŸ“„ è®¸å¯è¯

MIT License

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-01-03  
**å®ç°è€…**: AI Assistant  
**é¡¹ç›®**: ç•ªèŒ„å·¥å…·ç®± (tomato-tools)
